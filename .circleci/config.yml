version: 2.1

orbs:
  ruby: circleci/ruby@2.1.0
  gradle: circleci/gradle@3.0.0

jobs:
  build:
    docker:
      - image: cimg/base:stable
    parameters:
      build-lane:
        type: string
        default: "beta"
      java-version:
        type: string
        default: "17"
      enforced-branch:
        type: string
        default: ""
      build-number:
        type: string
        default: "github"
      commit-increment:
        type: string
        default: "false"
      publish-build:
        type: string
        default: "true"
      upload-artifacts:
        type: string
        default: "false"
      package-name:
        type: string
      google-json-key-base64:
        type: string
        default: ""
      artifact:
        type: string
        default: "aab"
      flavor:
        type: string
        default: ""
      build-type:
        type: string
        default: "Release"
      skip-signing:
        type: string
        default: "false"
      key-store-base64:
        type: string
        default: ""
      key-store-password:
        type: string
        default: ""
      key-alias:
        type: string
        default: ""
      key-password:
        type: string
        default: ""
    environment:
      TMPDIR: /tmp
    steps:
      - checkout
      - run:
          name: Install OpenJDK 17
          command: |
            sudo apt-get update
            sudo apt-get install -y openjdk-17-jdk
      - run:
          name: Install Node.js and NPM
          command: |
            sudo apt-get update
            sudo apt-get upgrade -y
            sudo apt install -y curl
            curl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash -
            sudo apt install -y nodejs
            node -v
      - ruby/install:
          version: "3.1.2"
      - run:
          name: Create Google JSON file
          if: << parameters.google-json-key-base64 != '' >>
          command: |
            echo "<< parameters.google-json-key-base64 >>" | base64 -d > "${TMPDIR}/__google_credentials.json"
      - run:
          name: Create Keystore file
          if: << parameters.key-store-base64 != '' >>
          command: |
            echo "<< parameters.key-store-base64 >>" | base64 -d > "${TMPDIR}/__keystore.jks"
      - run:
          name: Install Yarn
          command: sudo npm install -g yarn
      - run:
          name: Install Expo
          command: yarn add expo
      - run:
          name: Run Fastlane
          command: |
            chmod +x .circleci/fastlane.sh
            .circleci/fastlane.sh

workflows:
  version: 2
  build:
    jobs:
      - build:
          build-lane: ${FL_BUILD_LANE}
          java-version: ${FL_JAVA_VERSION}
          enforced-branch: ${FL_ENFORCED_BRANCH}
          build-number: ${FL_BUILD_NUMBER}
          commit-increment: ${FL_COMMIT_INCREMENT}
          publish-build: ${FL_PUBLISH_BUILD}
          upload-artifacts: ${FL_UPLOAD_ARTIFACTS}
          package-name: ${FL_PACKAGE_NAME}
          google-json-key-base64: ${FL_GOOGLE_JSON_KEY_BASE64}
          artifact: ${FL_ARTIFACT}
          flavor: ${FL_FLAVOR}
          build-type: ${FL_BUILD_TYPE}
          skip-signing: ${FL_SKIP_SIGNING}
          key-store-base64: ${FL_KEY_STORE_BASE64}
          key-store-password: ${FL_KEY_STORE_PASSWORD}
          key-alias: "circleci"
          key-password: "circleci"
