version: 2.1

orbs:
  ruby: circleci/ruby@2.1.0
  gradle: circleci/gradle@3.0.0

jobs:
  build:
    docker:
      - image: cimg/base:stable
    parameters:
      BUILD_LANE:
        type: string
        default: "android"
        description: "The name of the fastlane lane to run"
      JAVA_VERSION:
        type: string
        default: "17"
        description: "Java version"
      ANDROID_HOME:
        type: string
        default: ""
        description: "Android SDK path"
      FL_ANDROID_ENFORCED_BRANCH:
        type: string
        default: ""
      RUN_ID_AS_BUILD:
        type: string
        default: "true"
      FL_COMMIT_INCREMENT:
        type: string
        default: ""
      PUBLISH_BUILD:
        type: string
        default: "true"
      FL_ANDROID_PACKAGE_NAME:
        type: string
      FL_ANDROID_GOOGLE_JSON_KEY_BASE64:
        type: string
      FL_ANDROID_ARTIFACT:
        type: string
        default: "aab"
      FL_ANDROID_FLAVOR:
        type: string
      FL_ANDROID_BUILD_TYPE:
        type: string
        default: "Release"
      FL_ANDROID_SKIP_SIGNING:
        type: string
        default: "false"
      FL_ANDROID_KEY_STORE_BASE64:
        type: string
      FL_ANDROID_KEY_STORE_PASSWORD:
        type: string
      FL_ANDROID_KEY_ALIAS:
        type: string
      FL_ANDROID_KEY_PASSWORD:
        type: string
        description: "Android Keystore key password (required if signing is enabled)"
    steps:
      - checkout
      - run:
          name: Install OpenJDK 17
          command: |
            sudo apt-get update
            sudo apt-get install -y openjdk-17-jdk
      - run:
          name: Install Node.js and NPM
          command: |
            sudo apt-get update
            sudo apt-get upgrade -y
            sudo apt install -y curl
            curl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash -
            sudo apt install -y nodejs
            node -v
      - ruby/install:
          version: "3.1.2"
      - run:
          name: Create Google JSON file
          command: echo "${FL_ANDROID_GOOGLE_JSON_KEY_BASE64}" | base64 -d > /tmp/__google_credentials.json
      - run:
          name: Create Keystore file
          command: echo "${FL_ANDROID_KEY_STORE_BASE64}" | base64 -d > /tmp/__keystore.jks
      - run:
          name: Install yarn
          command: sudo npm install -g yarn
      - run:
          name: Install expo
          command: yarn add expo
      - run:
          name: Run Fastlane
          command: |
            chmod +x .circleci/fastlane.sh
            .circleci/fastlane.sh

workflows:
  version: 2
  build:
    jobs:
      - build:
          BUILD_LANE: "android"
          RUN_ID_AS_BUILD: "${RUN_ID_AS_BUILD}"
          FL_ANDROID_ENFORCED_BRANCH: "${FL_ANDROID_ENFORCED_BRANCH}"
          FL_COMMIT_INCREMENT: "${FL_COMMIT_INCREMENT}"
          FL_ANDROID_PACKAGE_NAME: "com.example.app"
          FL_ANDROID_GOOGLE_JSON_KEY_BASE64: "${FL_ANDROID_GOOGLE_JSON_KEY_BASE64}"
          FL_ANDROID_ARTIFACT: "apk"
          ANDROID_HOME: "/usr/local/android-sdk"
          FL_ANDROID_FLAVOR: "${FL_ANDROID_FLAVOR}"
          FL_ANDROID_BUILD_TYPE: "Debug"
          FL_ANDROID_SKIP_SIGNING: "true"
          FL_ANDROID_KEY_STORE_BASE64: "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"
          FL_ANDROID_KEY_STORE_PASSWORD: "llawliet"
          FL_ANDROID_KEY_ALIAS: "trak_key"
          FL_ANDROID_KEY_PASSWORD: "${FL_ANDROID_KEY_PASSWORD}"
