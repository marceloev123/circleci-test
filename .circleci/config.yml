version: 2.1

orbs:
  ruby: circleci/ruby@2.1.0
  gradle: circleci/gradle@3.0.0

jobs:
  build:
    docker:
      - image: cimg/base:stable
    parameters:
      BUILD_LANE:
        type: string
        default: "android"
        description: "The name of the fastlane lane to run"
      JAVA_VERSION:
        type: string
        default: "17"
        description: "Java version"
      ANDROID_HOME:
        type: string
        default: ""
        description: "Android SDK path"
      FL_ANDROID_ENFORCED_BRANCH:
        type: string
        default: ""
      RUN_ID_AS_BUILD:
        type: string
        default: "true"
      FL_COMMIT_INCREMENT:
        type: string
        default: ""
      PUBLISH_BUILD:
        type: string
        default: "true"
      FL_ANDROID_PACKAGE_NAME:
        type: string
      FL_ANDROID_GOOGLE_JSON_KEY_BASE64:
        type: string
      FL_ANDROID_ARTIFACT:
        type: string
        default: "aab"
      FL_ANDROID_FLAVOR:
        type: string
      FL_ANDROID_BUILD_TYPE:
        type: string
        default: "Release"
      FL_ANDROID_SKIP_SIGNING:
        type: string
        default: "false"
      FL_ANDROID_KEY_STORE_BASE64:
        type: string
      FL_ANDROID_KEY_STORE_PASSWORD:
        type: string
      FL_ANDROID_KEY_ALIAS:
        type: string
      FL_ANDROID_KEY_PASSWORD:
        type: string
        description: "Android Keystore key password (required if signing is enabled)"
    steps:
      - checkout
      - run:
          name: Install OpenJDK 17
          command: |
            sudo apt-get update
            sudo apt-get install -y openjdk-17-jdk
      - run:
          name: Install Node.js and NPM
          command: |
            sudo apt-get update
            sudo apt-get upgrade -y
            sudo apt install -y curl
            curl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash -
            sudo apt install -y nodejs
            node -v
      - ruby/install:
          version: "3.1.2"
      - run:
          name: Create Google JSON file
          command: echo "${FL_ANDROID_GOOGLE_JSON_KEY_BASE64}" | base64 -d > /tmp/__google_credentials.json
      - run:
          name: Create Keystore file
          command: echo "${FL_ANDROID_KEY_STORE_BASE64}" | base64 -d > /tmp/__keystore.jks
      - run:
          name: Install yarn
          command: sudo npm install -g yarn
      - run:
          name: Install expo
          command: yarn add expo
      - run:
          name: Run Fastlane
          command: |
            chmod +x .circleci/fastlane.sh
            .circleci/fastlane.sh
          environment:
            BUILD_LANE: "${BUILD_LANE}"
            RUN_ID_AS_BUILD: "${RUN_ID_AS_BUILD}"
            ANDROID_HOME: /usr/local/android-sdk-linux
            FL_ANDROID_ENFORCED_BRANCH: "${FL_ANDROID_ENFORCED_BRANCH}"
            FL_COMMIT_INCREMENT: "${FL_COMMIT_INCREMENT}"
            FL_ANDROID_PACKAGE_NAME: "${FL_ANDROID_PACKAGE_NAME}"
            FL_ANDROID_GOOGLE_JSON_FILE: /tmp/__google_credentials.json
            FL_ANDROID_KEY_STORE_BASE64: "${FL_ANDROID_KEY_STORE_BASE64}"
            FL_ANDROID_KEY_STORE: /tmp/__keystore.jks
            FL_ANDROID_ARTIFACT: "${FL_ANDROID_ARTIFACT}"
            FL_ANDROID_FLAVOR: "${FL_ANDROID_FLAVOR}"
            FL_ANDROID_BUILD_TYPE: "${FL_ANDROID_BUILD_TYPE}"
            FL_ANDROID_SKIP_SIGNING: "${FL_ANDROID_SKIP_SIGNING}"
            FL_ANDROID_ANDROID_STORE_FILE: /tmp/__keystore.jks
            FL_ANDROID_KEY_STORE_PASSWORD: "${FL_ANDROID_KEY_STORE_PASSWORD}"
            FL_ANDROID_KEY_ALIAS: "${FL_ANDROID_KEY_ALIAS}"
            FL_ANDROID_KEY_PASSWORD: "${FL_ANDROID_KEY_PASSWORD}"

workflows:
  version: 2
  build:
    jobs:
      - build:
          BUILD_LANE: "android"
          RUN_ID_AS_BUILD: "${RUN_ID_AS_BUILD}"
          FL_ANDROID_ENFORCED_BRANCH: "${FL_ANDROID_ENFORCED_BRANCH}"
          FL_COMMIT_INCREMENT: "${FL_COMMIT_INCREMENT}"
          FL_ANDROID_PACKAGE_NAME: "com.example.app"
          FL_ANDROID_GOOGLE_JSON_KEY_BASE64: "${FL_ANDROID_GOOGLE_JSON_KEY_BASE64}"
          FL_ANDROID_ARTIFACT: "apk"
          ANDROID_HOME: "/usr/local/android-sdk"
          FL_ANDROID_FLAVOR: "${FL_ANDROID_FLAVOR}"
          FL_ANDROID_BUILD_TYPE: "Debug"
          FL_ANDROID_SKIP_SIGNING: "${FL_ANDROID_SKIP_SIGNING}"
          FL_ANDROID_KEY_STORE_BASE64: "${FL_ANDROID_KEY_STORE_BASE64}"
          FL_ANDROID_KEY_STORE_PASSWORD: "${FL_ANDROID_KEY_STORE_PASSWORD}"
          FL_ANDROID_KEY_ALIAS: "${FL_ANDROID_KEY_ALIAS}"
          FL_ANDROID_KEY_PASSWORD: "${FL_ANDROID_KEY_PASSWORD}"
