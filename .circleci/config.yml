version: 2.1

parameters:
  build-lane:
    type: string
    default: "beta"
  java-version:
    type: string
    default: "17"
  enforced-branch:
    type: string
    default: ""
  build-number:
    type: string
    default: "github"
  commit-increment:
    type: string
    default: "false"
  publish-build:
    type: string
    default: "true"
  upload-artifacts:
    type: string
    default: "false"
  package-name:
    type: string
  google-json-key-base64:
    type: string
    default: ""
  artifact:
    type: string
    default: "aab"
  flavor:
    type: string
    default: ""
  build-type:
    type: string
    default: "Release"
  skip-signing:
    type: string
    default: "false"
  key-store-base64:
    type: string
    default: ""
  key-store-password:
    type: string
    default: ""
  key-alias:
    type: string
    default: ""
  key-password:
    type: string
    default: ""

jobs:
  build:
    docker:
      - image: cimg/base:stable
    environment:
      TMPDIR: /tmp
    steps:
      - checkout
      - run:
          name: Install OpenJDK 17
          command: |
            sudo apt-get update
            sudo apt-get install -y openjdk-17-jdk
      - run:
          name: Install Node.js and NPM
          command: |
            sudo apt-get update
            sudo apt-get upgrade -y
            sudo apt install -y curl
            curl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash -
            sudo apt install -y nodejs
            node -v
      - run:
          name: Install Ruby 3.1.2
          command: |
            sudo apt-get install -y software-properties-common
            sudo apt-add-repository -y ppa:rael-gc/rvm
            sudo apt-get update
            sudo apt-get install -y rvm
            source /etc/profile.d/rvm.sh
            rvm install 3.1.2
            rvm use 3.1.2
      - run:
          name: Create Google JSON file
          if: ${{ parameters.google-json-key-base64 != '' }}
          command: |
            echo "${{ parameters.google-json-key-base64 }}" | base64 -d > "${TMPDIR}/__google_credentials.json"
      - run:
          name: Create Keystore file
          if: ${{ parameters.key-store-base64 != '' }}
          command: |
            echo "${{ parameters.key-store-base64 }}" | base64 -d > "${TMPDIR}/__keystore.jks"
      - run:
          name: Install Yarn
          command: sudo npm install -g yarn
      - run:
          name: Install Expo
          command: yarn add expo
      - run:
          name: Run Fastlane
          command: |
            chmod +x .circleci/fastlane.sh
            .circleci/fastlane.sh

workflows:
  version: 2
  build:
    jobs:
      - build:
          build-lane: "${{ parameters.build-lane }}"
          java-version: "${{ parameters.java-version }}"
          enforced-branch: "${{ parameters.enforced-branch }}"
          build-number: "${{ parameters.build-number }}"
          commit-increment: "${{ parameters.commit-increment }}"
          publish-build: "${{ parameters.publish-build }}"
          upload-artifacts: "${{ parameters.upload-artifacts }}"
          package-name: "${{ parameters.package-name }}"
          google-json-key-base64: "${{ parameters.google-json-key-base64 }}"
          artifact: "${{ parameters.artifact }}"
          flavor: "${{ parameters.flavor }}"
          build-type: "${{ parameters.build-type }}"
          skip-signing: "${{ parameters.skip-signing }}"
          key-store-base64: "${{ parameters.key-store-base64 }}"
          key-store-password: "${{ parameters.key-store-password }}"
          key-alias: "${{ parameters.key-alias }}"
          key-password: "${{ parameters.key-password }}"
