version: 2.1

orbs:
  ruby: circleci/ruby@2.1.0
  gradle: circleci/gradle@3.0.0

jobs:
  build:
    docker:
      - image: cimg/base:stable
    parameters:
      BUILD_LANE:
        type: string
        default: "android"
        description: "The name of the fastlane lane to run"
      JAVA_VERSION:
        type: string
        default: "17"
        description: "Java version"
      ANDROID_HOME:
        type: string
        default: ""
        description: "Android SDK path"
      ENFORCED_BRANCH:
        type: string
        default: ""
      RUN_ID_AS_BUILD:
        type: string
        default: "true"
      COMMIT_INCREMENT:
        type: string
        default: ""
      PUBLISH_BUILD:
        type: string
        default: "true"
      PACKAGE_NAME:
        type: string
      GOOGLE_JSON_KEY_BASE64:
        type: string
      ARTIFACT:
        type: string
        default: "aab"
      FLAVOR:
        type: string
      BUILD_TYPE:
        type: string
        default: "Release"
      SKIP_SIGNING:
        type: string
        default: "false"
      KEY_STORE_BASE64:
        type: string
      KEY_STORE_PASSWORD:
        type: string
      KEY_ALIAS:
        type: string
      KEY_PASSWORD:
        type: string
        description: "Android Keystore key password (required if signing is enabled)"
    steps:
      - checkout
      # Install OpenJDK 17 (Java)
      - run:
          name: Install OpenJDK 17
          command: |
            sudo apt-get update
            sudo apt-get install -y openjdk-17-jdk

      # Install Node.js and NPM
      - run:
          name: Install Node.js and NPM
          command: |
            sudo apt-get update
            sudo apt-get upgrade
            sudo apt install -y curl
            curl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash -
            sudo apt install -y nodejs
            node -v
      - ruby/install:
          version: "3.1.2"
      - run:
          name: Create Google JSON file
          command: echo "${google_json_key_base64}" | base64 -d > /tmp/__google_credentials.json
      - run:
          name: Create Keystore file
          command: echo "${KEY_STORE_BASE64}" | base64 -d > /tmp/__keystore.jks
      - run:
          name: Install yarn
          command: sudo npm install -g yarn
      - run:
          name: Install expo
          command: yarn add expo
      - run:
          name: Run Fastlane
          command: |
            chmod +x .circleci/fastlane.sh
            .circleci/fastlane.sh
          environment:
            BUILD_LANE: "beta"
            RUN_ID_AS_BUILD: "${run_id_as_build}"
            RUN_ID: "${CIRCLECI_BUILD_NUM}"
            ANDROID_HOME: /usr/local/android-sdk-linux
            FL_ENFORCED_BRANCH: "${FL_ENFORCED_BRANCH}"
            FL_COMMIT_INCREMENT: "${FL_COMMIT_INCREMENT}"
            FL_PUBLISH_BUILD: "${FL_PUBLISH_BUILD}"
            FL_PACKAGE_NAME: "${PACKAGE_NAME}"
            FL_GOOGLE_JSON_FILE: /tmp/__google_credentials.json
            FL_KEY_STORE_BASE64: MIIKvAIBAzCCCmYGCSqGSIb3DQEHAaCCClcEggpTMIIKTzCCBbYGCSqGSIb3DQEHAaCCBacEggWjMIIFnzCCBZsGCyqGSIb3DQEMCgECoIIFQDCCBTwwZgYJKoZIhvcNAQUNMFkwOAYJKoZIhvcNAQUMMCsEFI
            FL_KEY_STORE: /tmp/__keystore.jks
            FL_ANDROID_ARTIFACT: "${ARTIFACT}"
            FL_ANDROID_FLAVOR: "${FLAVOR}"
            FL_ANDROID_BUILD_TYPE: "${BUILD_TYPE}"
            FL_ANDROID_SKIP_SIGNING: "${SKIP_SIGNING}"
            FL_ANDROID_STORE_FILE: /tmp/__keystore.jks
            FL_ANDROID_STORE_PASSWORD: "${STORE_PASSWORD}"
            FL_ANDROID_KEY_ALIAS: "${KEY_ALIAS}"
            FL_ANDROID_KEY_PASSWORD: "${KEY_PASSWORD}"

workflows:
  version: 2
  build:
    jobs:
      - build:
          BUILD_LANE: "android"
          RUN_ID_AS_BUILD: "${RUN_ID_AS_BUILD}"
          FL_ENFORCED_BRANCH: "${ENFORCED_BRANCH}"
          FL_COMMIT_INCREMENT: "${COMMIT_INCREMENT}"
          FL_PACKAGE_NAME: "com.example.app"
          FL_GOOGLE_JSON_KEY_BASE64: "${GOOGLE_JSON_KEY_BASE64}"
          FL_ARTIFACT: "apk"
          FL_ANDROID_HOME: "/usr/local/android-sdk"
          FL_FLAVOR: "${FLAVOR}"
          FL_BUILD_TYPE: "Debug"
          FL_SKIP_SIGNING: "true"
          FL_KEY_STORE_BASE64: "${KEY_STORE_BASE64}"
          FL_KEY_STORE_PASSWORD: "${KEY_STORE_PASSWORD}"
          FL_KEY_ALIAS: "${KEY_ALIAS}"
          FL_KEY_PASSWORD: "${KEY_PASSWORD}"
